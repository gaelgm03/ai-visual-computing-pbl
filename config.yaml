# MASt3R Face Authentication System - Configuration
# All tunable parameters in one place
# Version: 1.0

# ============================================================
# Frontend Configuration (CS-2)
# ============================================================
frontend:
  # Gradio server settings
  server:
    host: "0.0.0.0"
    port: 7860
    share: false
  
  # Webcam capture settings
  webcam:
    width: 640
    height: 480
    fps: 30
    device_id: 0
  
  # Enrollment UI settings
  enrollment:
    target_frames: 12
    min_yaw_spread: 40.0      # degrees
    min_pitch_spread: 20.0    # degrees
    max_roll: 15.0            # reject frames with excessive roll
    quality_threshold: 0.9     # minimum face detection confidence
  
  # Authentication UI settings
  auth:
    capture_frames: 4
    frame_delay_ms: 200
  
  # Visualization settings
  visualization:
    max_points: 10000         # subsample for performance
    point_size: 1.5

# ============================================================
# API Configuration (CS-1 defines, CS-2 consumes)
# ============================================================
api:
  base_url: "http://localhost:8000"
  endpoints:
    enroll_ws: "/ws/enroll"
    authenticate: "/authenticate"
    users: "/users"
  timeout_sec: 30

# ============================================================
# MASt3R Engine Configuration (CS-1)
# ============================================================
mast3r:
  checkpoint: "naver/MASt3R_ViTLarge_BaseDecoder_512_catmlpdpt_metric"
  image_size: 512
  force_fp16: true            # Mandatory on 8GB GPU
  device: "cuda"

# ============================================================
# Global Alignment Configuration (CS-1)
# Uses MASt3R-SfM's sparse_global_alignment for coordinate unification
# ============================================================
global_alignment:
  enabled: true               # Use global alignment (recommended)
  subsample: 8                # Subsampling factor for correspondences
  lr1: 0.07                   # Learning rate for coarse alignment
  niter1: 300                 # Iterations for coarse alignment
  lr2: 0.014                  # Learning rate for refinement (increased for better convergence)
  niter2: 500                 # Iterations for refinement (increased: fine loss plateaus at 300)
  cache_dir: "storage/alignment_cache"  # Cache for intermediate results

# ============================================================
# Post-Processing Configuration (CS-1)
# Controls noise removal pipeline after 3D reconstruction:
#   confidence filter → voxel dedup → outlier removal → cluster filter
# ============================================================
post_processing:
  confidence_threshold: 1.5     # MASt3R conf >= this kept (>1 reliable, 1.0-1.5 marginal)

  dedup:
    distance_threshold: 0.01    # Voxel size in meters (10mm merges double-layer artifacts)
    max_points: 200000          # Hard cap after dedup (keep highest confidence)

  outlier_removal:
    k_neighbors: 30             # K for mean k-NN distance calculation
    std_ratio: 1.2              # Remove if mean_dist > global_mean + std_ratio * global_std

  cluster_filter:
    k_neighbors: 10             # K for building connectivity graph
    eps: 0.011                  # Max edge distance in meters (tightened from 0.02 for less side noise)

# ============================================================
# Face Detection Configuration (CS-1)
# ============================================================
face_detection:
  model: "mediapipe"          # or "dlib"
  min_detection_confidence: 0.9
  min_tracking_confidence: 0.5
  face_padding: 0.3           # padding around face bbox (0.3 is optimal: enough face detail, minimal background shift)

# ============================================================
# Keyframe Selection Configuration (CS-1)
# ============================================================
keyframe:
  target_count: 12
  min_yaw_spread: 40.0
  min_pitch_spread: 20.0
  pose_novelty_threshold: 5.0  # min degrees delta for new keyframe
  blur_threshold: 15.0         # Laplacian variance threshold (clean frame without UI overlays)
  auto_export: true            # Auto-save keyframes when target_count reached
  export_dir: "storage/demo_keyframes"

# ============================================================
# Face Embedding Configuration (ArcFace identity recognition)
# Produces 512-dim identity-discriminative embeddings.
# This is the PRIMARY identity signal (replaces MASt3R descriptors).
# ============================================================
face_embedding:
  model: "buffalo_l"            # insightface model bundle (ArcFace R100)
  embedding_dim: 512
  device: "cuda"                # "cuda" or "cpu" (fallback if ONNX incompatible)
  backend: "auto"               # "insightface", "facenet", or "auto" (try insightface first)

# ============================================================
# Matching Configuration (DS team tunes these)
# ============================================================
matching:
  embedding_weight: 0.7         # ArcFace embedding (primary identity signal)
  geometric_weight: 0.3         # ICP + Chamfer (supplementary 3D shape signal)
  descriptor_weight: 0.0        # MASt3R descriptors (disabled — no identity discrimination)
  accept_threshold: 0.55        # final score threshold for accept (to be tuned via grid search)

  icp:
    max_iterations: 50
    convergence_threshold: 1e-6
    max_correspondence_distance: 0.05

# ============================================================
# Anti-Spoofing Configuration (CS-1 builds, DS-2 tunes)
# ============================================================
anti_spoof:
  enabled: true
  depth_std_threshold: 0.003   # meters (3mm)
  planarity_ratio_threshold: 0.05
  confidence_mean_threshold: 0.7

# ============================================================
# Storage Configuration
# ============================================================
storage:
  templates_dir: "storage/templates"
  db_path: "storage/db.sqlite"

# ============================================================
# Logging Configuration
# ============================================================
logging:
  level: "INFO"               # DEBUG, INFO, WARNING, ERROR
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"

# ============================================================
# Random Seed (for reproducibility)
# ============================================================
seed: 42
